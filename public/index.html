<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Evacuation System</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cream: '#edede9',
                        sand: '#d6ccc2',
                        linen: '#f5ebe0',
                        tan: '#e3d5ca',
                        taupe: '#d5bdaf',
                    },
                    fontFamily: {
                        'display': ['Space Grotesk', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        * {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #edede9 0%, #f5ebe0 50%, #e3d5ca 100%);
            background-attachment: fixed;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(227, 213, 202, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        .glass-card-dark {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid #e3d5ca;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.12);
        }

        .btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #d5bdaf 0%, #d6ccc2 100%);
            color: #000;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(213, 189, 175, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(213, 189, 175, 0.4);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .status-indicator {
            position: relative;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-ring {
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        @keyframes ping {
            75%, 100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.875rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.025em;
        }

        .badge-success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border: 1px solid #86efac;
        }

        .badge-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .badge-danger {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .loading-spinner {
            width: 2.5rem;
            height: 2.5rem;
            border: 3px solid #e3d5ca;
            border-top-color: #d5bdaf;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #video-container {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-radius: 1rem;
            overflow: hidden;
            aspect-ratio: 16/9;
            position: relative;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .result-card {
            background: white;
            border: 1px solid #f5ebe0;
            border-radius: 1rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #d5bdaf 0%, #d6ccc2 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .result-card:hover {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .result-card:hover::before {
            opacity: 1;
        }

        .result-card.hazard {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.15);
        }

        .result-card.hazard::before {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
            opacity: 1;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f5ebe0;
            transition: all 0.2s;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-row:hover {
            padding-left: 0.5rem;
            background: linear-gradient(90deg, rgba(245, 235, 224, 0.3) 0%, transparent 100%);
        }

        .instruction-card {
            background: linear-gradient(135deg, rgba(245, 235, 224, 0.6) 0%, rgba(227, 213, 202, 0.4) 100%);
            border-left: 4px solid #d5bdaf;
            backdrop-filter: blur(8px);
        }

        .icon-wrapper {
            width: 2.5rem;
            height: 2.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f5ebe0 0%, #e3d5ca 100%);
            border-radius: 0.5rem;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f5ebe0;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d5bdaf;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #d6ccc2;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto space-y-6">
        <!-- Header -->
        <div class="glass-card-dark rounded-2xl overflow-hidden">
            <div class="p-6 md:p-8">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <div class="icon-wrapper">
                                <i data-lucide="siren" class="w-5 h-5 text-red-600"></i>
                            </div>
                            <h1 class="text-3xl md:text-4xl font-bold text-black tracking-tight">
                                Emergency Evacuation System
                            </h1>
                        </div>
                        <p class="text-gray-600 font-medium ml-14">Real-time Video Analysis & AI-Powered Guidance</p>
                    </div>
                    <div class="flex items-center gap-3 px-5 py-3 rounded-full glass-card">
                        <div class="relative">
                            <div id="connection-ring" class="status-ring" style="border: 2px solid #ef4444;"></div>
                            <div id="connection-dot" class="w-3 h-3 rounded-full status-indicator" style="background: #ef4444;"></div>
                        </div>
                        <span id="connection-text" class="text-sm font-semibold text-gray-700 font-mono">CONNECTING...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="instruction-card rounded-2xl p-6 md:p-8">
            <div class="flex items-start gap-4">
                <div class="icon-wrapper">
                    <i data-lucide="info" class="w-5 h-5 text-taupe"></i>
                </div>
                <div class="flex-1">
                    <h3 class="font-bold text-xl mb-4 text-black">Quick Start Guide</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 rounded-full bg-taupe text-white flex items-center justify-center text-sm font-bold mt-0.5">1</div>
                            <p class="text-gray-800"><span class="font-semibold">Enable Camera</span> - Click "Start Camera" and allow permissions</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 rounded-full bg-taupe text-white flex items-center justify-center text-sm font-bold mt-0.5">2</div>
                            <p class="text-gray-800"><span class="font-semibold">Point & Scan</span> - Aim at your environment</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 rounded-full bg-taupe text-white flex items-center justify-center text-sm font-bold mt-0.5">3</div>
                            <p class="text-gray-800"><span class="font-semibold">Watch Analysis</span> - Real-time results appear instantly</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 rounded-full bg-taupe text-white flex items-center justify-center text-sm font-bold mt-0.5">4</div>
                            <p class="text-gray-800"><span class="font-semibold">Test Features</span> - Show obstacles, people, or hazards</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <!-- Video Panel -->
            <div class="glass-card-dark rounded-2xl overflow-hidden">
                <div class="p-5 border-b border-gray-200">
                    <div class="flex items-center gap-3">
                        <div class="icon-wrapper">
                            <i data-lucide="video" class="w-5 h-5 text-taupe"></i>
                        </div>
                        <h2 class="text-xl font-bold text-black">Live Camera Feed</h2>
                    </div>
                </div>
                <div class="p-6 space-y-4">
                    <div id="video-container" class="relative group">
                        <video id="video" autoplay playsinline muted></video>
                        <div class="absolute top-4 left-4 px-4 py-2 rounded-xl text-sm font-bold font-mono backdrop-blur-md flex items-center gap-2"
                             style="background: rgba(0, 0, 0, 0.8); color: white; border: 1px solid rgba(255, 255, 255, 0.1);"
                             id="video-status">
                            <i data-lucide="camera-off" class="w-4 h-4"></i>
                            <span>CAMERA INACTIVE</span>
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="start-btn" onclick="startCamera()"
                                class="btn btn-primary px-6 py-4 rounded-xl font-bold text-base tracking-wide flex items-center justify-center gap-2">
                            <i data-lucide="play" class="w-5 h-5"></i>
                            START CAMERA
                        </button>
                        <button id="stop-btn" onclick="stopCamera()" disabled
                                class="btn btn-danger px-6 py-4 rounded-xl font-bold text-base tracking-wide flex items-center justify-center gap-2">
                            <i data-lucide="square" class="w-5 h-5"></i>
                            STOP CAMERA
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analysis Panel -->
            <div class="glass-card-dark rounded-2xl overflow-hidden">
                <div class="p-5 border-b border-gray-200">
                    <div class="flex items-center gap-3">
                        <div class="icon-wrapper">
                            <i data-lucide="activity" class="w-5 h-5 text-taupe"></i>
                        </div>
                        <h2 class="text-xl font-bold text-black">Real-Time Analysis</h2>
                    </div>
                </div>
                <div class="p-6">
                    <div id="analysis-results" class="space-y-4 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
                        <div class="flex flex-col items-center justify-center py-16 text-center">
                            <div class="loading-spinner mb-6"></div>
                            <p class="font-bold text-lg text-gray-800 mb-2">Awaiting Video Stream</p>
                            <p class="text-sm text-gray-500 font-mono">Analysis will begin automatically ‚Ä¢ 0.5-1s updates</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Configuration
        const SERVER_URL = window.location.origin;
        const USER_ID = 'user-' + Date.now();

        // State
        let socket = null;
        let visionSession = null;
        let mediaStream = null;
        let resultCount = 0;

        // Initialize Socket.IO
        function initSocket() {
            socket = io(SERVER_URL);

            socket.on('connect', () => {
                console.log('‚úÖ Connected to server');
                updateConnectionStatus(true);
                socket.emit('register-user', {
                    userId: USER_ID,
                    position: { x: 0, y: 0, z: 0 }
                });
            });

            socket.on('disconnect', () => {
                console.log('‚ùå Disconnected from server');
                updateConnectionStatus(false);
            });

            socket.on('processing-error', (error) => {
                console.error('‚ùå Processing error:', error);
                showError(error.message);
            });
        }

        function updateConnectionStatus(connected) {
            const dot = document.getElementById('connection-dot');
            const ring = document.getElementById('connection-ring');
            const text = document.getElementById('connection-text');

            if (connected) {
                dot.style.background = '#22c55e';
                ring.style.borderColor = '#22c55e';
                text.textContent = 'CONNECTED';
                text.style.color = '#22c55e';
            } else {
                dot.style.background = '#ef4444';
                ring.style.borderColor = '#ef4444';
                text.textContent = 'DISCONNECTED';
                text.style.color = '#ef4444';
            }
        }

        function updateVideoStatus(icon, text, bgColor = 'rgba(0, 0, 0, 0.8)', textColor = 'white') {
            const videoStatus = document.getElementById('video-status');
            videoStatus.innerHTML = `
                <i data-lucide="${icon}" class="w-4 h-4"></i>
                <span>${text}</span>
            `;
            videoStatus.style.background = bgColor;
            videoStatus.style.color = textColor;
            lucide.createIcons();
        }

        function showError(message) {
            updateVideoStatus('alert-circle', message.toUpperCase(), 'rgba(239, 68, 68, 0.95)', 'white');
        }

        window.startCamera = async function() {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const videoElement = document.getElementById('video');

            try {
                startBtn.disabled = true;
                updateVideoStatus('loader-2', 'REQUESTING ACCESS...', 'rgba(213, 189, 175, 0.95)', 'black');

                console.log('üé• Requesting camera access...');

                // Get camera stream
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                console.log('‚úÖ Camera access granted');
                videoElement.srcObject = mediaStream;

                // Load Overshoot SDK
                console.log('üì¶ Loading Overshoot SDK...');

                let RealtimeVision;
                const cdnUrls = [
                    'https://cdn.jsdelivr.net/npm/@overshoot/sdk@latest/dist/index.js',
                    'https://esm.sh/@overshoot/sdk@latest',
                    'https://unpkg.com/@overshoot/sdk@latest/dist/index.js',
                    'https://unpkg.com/@overshoot/sdk@latest'
                ];

                let lastError = null;
                for (const url of cdnUrls) {
                    try {
                        console.log(`Trying to load from: ${url}`);
                        const module = await import(url);
                        console.log('Module loaded:', module);
                        RealtimeVision = module.RealtimeVision || module.default?.RealtimeVision || module.default;
                        if (RealtimeVision) {
                            console.log('‚úÖ Overshoot SDK loaded successfully from:', url);
                            break;
                        }
                    } catch (importError) {
                        console.warn(`Failed to load from ${url}:`, importError);
                        lastError = importError;
                    }
                }

                if (!RealtimeVision) {
                    console.error('All CDN attempts failed. Last error:', lastError);
                    throw new Error(`Failed to load Overshoot SDK. Error: ${lastError?.message || 'Unknown error'}`);
                }

                console.log('üîß Initializing Overshoot...');
                visionSession = new RealtimeVision({
                    apiUrl: 'https://cluster1.overshoot.ai/api/v0.2',
                    apiKey: 'ovs_4488f728fc52c4d2ca6f8972c7cc53e3',
                    prompt: `Analyze this emergency evacuation video frame and identify:

1. OBSTACLES: Any physical blockages in the path (debris, furniture, locked doors)
2. HAZARDS:
   - Fire: location and intensity on scale 1-5, growth rate (stable/growing/rapid)
   - Smoke: density on scale 1-5, height from floor, visibility level
   - Water: flooding depth and flow rate
3. PEOPLE: Count of visible people and their approximate positions (left/center/right, near/far), density level, movement direction
4. EXITS: Any visible exit signs or doors, their status (clear/blocked/partially_blocked), approximate direction in degrees from center (0=straight ahead)

Respond in JSON format with this structure:
{
  "obstacles": [...],
  "hazards": {"fire": {...}, "smoke": {...}, "water": {...}},
  "people": {"count": 0, "density": "clear"},
  "exits": [...]
}`,
                    onResult: handleAnalysisResult
                });

                console.log('‚ñ∂Ô∏è Starting analysis...');

                try {
                    await visionSession.start();

                    stopBtn.disabled = false;
                    updateVideoStatus('eye', 'ANALYZING LIVE', 'rgba(34, 197, 94, 0.95)', 'white');

                    document.getElementById('analysis-results').innerHTML = '';
                    console.log('‚úÖ System active!');
                } catch (startError) {
                    console.error('Failed to start Overshoot session:', startError);
                    throw startError;
                }

            } catch (error) {
                console.error('‚ùå Failed to start:', error);
                showError(error.message);
                startBtn.disabled = false;

                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
            }
        };

        window.stopCamera = async function() {
            console.log('üõë Stopping camera...');

            if (visionSession) {
                await visionSession.stop();
                visionSession = null;
            }

            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }

            const videoElement = document.getElementById('video');
            videoElement.srcObject = null;

            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            updateVideoStatus('camera-off', 'CAMERA INACTIVE');

            if (socket) {
                socket.emit('stop-processing', { userId: USER_ID });
            }

            console.log('‚úÖ Camera stopped');
        };

        function handleAnalysisResult(result) {
            console.log('üìä Analysis result:', result);
            console.log('   AI Response:', result.result);
            console.log('   Inference latency:', result.inference_latency_ms, 'ms');
            console.log('   Total latency:', result.total_latency_ms, 'ms');

            resultCount++;

            let analysis;
            try {
                // Parse the AI response
                analysis = JSON.parse(result.result);
            } catch (e) {
                console.error('Parse error:', e);
                console.log('Raw result:', result.result);
                // If parsing fails, try to use the result as-is or create minimal structure
                analysis = {
                    confidence: 0.5,
                    obstacles: [],
                    hazards: { fire: { present: false }, smoke: { present: false }, water: { present: false } },
                    people: { count: 0, density: 'unknown' },
                    exits: []
                };
            }

            displayAnalysisResult(analysis, result);

            if (socket) {
                socket.emit('video-analysis', {
                    userId: USER_ID,
                    analysis,
                    latency: result.total_latency_ms
                });
            }

            const videoStatus = document.getElementById('video-status');
            videoStatus.innerHTML = `
                <i data-lucide="eye" class="w-4 h-4"></i>
                <span>LIVE ‚Ä¢ ${resultCount} results ‚Ä¢ ${result.total_latency_ms}ms</span>
            `;
            lucide.createIcons();
        }

        function displayAnalysisResult(analysis, metadata) {
            const container = document.getElementById('analysis-results');
            const hasHazards = analysis.hazards?.fire?.present ||
                             analysis.hazards?.smoke?.present ||
                             analysis.hazards?.water?.present;

            const resultCard = document.createElement('div');
            resultCard.className = 'result-card' + (hasHazards ? ' hazard' : '');

            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            const confidence = ((analysis.confidence || 0) * 100).toFixed(0);

            resultCard.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <span class="text-sm font-mono font-semibold text-gray-500 flex items-center gap-2">
                        <i data-lucide="clock" class="w-3 h-3"></i>
                        ${timestamp}
                    </span>
                    <span class="badge badge-success">
                        <i data-lucide="check-circle" class="w-3 h-3"></i>
                        ${confidence}% CONFIDENCE
                    </span>
                </div>

                ${hasHazards ? '<div class="text-red-600 font-bold text-lg mb-4 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-6 h-6"></i> HAZARDS DETECTED</div>' : ''}

                <div class="space-y-1">
                    <div class="metric-row">
                        <span class="font-semibold text-gray-700 flex items-center gap-2">
                            <i data-lucide="box" class="w-5 h-5 text-gray-600"></i>
                            Obstacles
                        </span>
                        <span class="font-mono font-bold text-gray-900">${analysis.obstacles?.length || 0}</span>
                    </div>

                    <div class="metric-row">
                        <span class="font-semibold text-gray-700 flex items-center gap-2">
                            <i data-lucide="flame" class="w-5 h-5 text-orange-600"></i>
                            Fire
                        </span>
                        <span class="text-gray-900">
                            ${analysis.hazards?.fire?.present ?
                                `<span class="badge badge-danger"><i data-lucide="flame" class="w-3 h-3"></i> LVL ${analysis.hazards.fire.intensity}</span>` :
                                '<span class="font-mono text-gray-500">NONE</span>'}
                        </span>
                    </div>

                    <div class="metric-row">
                        <span class="font-semibold text-gray-700 flex items-center gap-2">
                            <i data-lucide="cloud" class="w-5 h-5 text-gray-600"></i>
                            Smoke
                        </span>
                        <span class="text-gray-900">
                            ${analysis.hazards?.smoke?.present ?
                                `<span class="badge badge-warning"><i data-lucide="cloud" class="w-3 h-3"></i> LVL ${analysis.hazards.smoke.density}</span>` :
                                '<span class="font-mono text-gray-500">NONE</span>'}
                        </span>
                    </div>

                    <div class="metric-row">
                        <span class="font-semibold text-gray-700 flex items-center gap-2">
                            <i data-lucide="droplets" class="w-5 h-5 text-blue-600"></i>
                            Water
                        </span>
                        <span class="text-gray-900">
                            ${analysis.hazards?.water?.present ?
                                `<span class="badge badge-warning"><i data-lucide="droplets" class="w-3 h-3"></i> ${analysis.hazards.water.depth.toUpperCase()}</span>` :
                                '<span class="font-mono text-gray-500">NONE</span>'}
                        </span>
                    </div>

                    <div class="metric-row">
                        <span class="font-semibold text-gray-700 flex items-center gap-2">
                            <i data-lucide="users" class="w-5 h-5 text-gray-600"></i>
                            People
                        </span>
                        <span class="font-mono font-bold text-gray-900">${analysis.people?.count || 0} <span class="text-sm text-gray-500">(${analysis.people?.density || 'unknown'})</span></span>
                    </div>

                    <div class="metric-row">
                        <span class="font-semibold text-gray-700 flex items-center gap-2">
                            <i data-lucide="door-open" class="w-5 h-5 text-green-600"></i>
                            Exits
                        </span>
                        <span class="font-mono font-bold text-gray-900">${(analysis.exits || []).filter(e => e.visible).length} visible</span>
                    </div>

                    <div class="metric-row">
                        <span class="font-semibold text-gray-700 flex items-center gap-2">
                            <i data-lucide="timer" class="w-5 h-5 text-gray-600"></i>
                            Latency
                        </span>
                        <span class="font-mono font-bold text-gray-900">${metadata.total_latency_ms}ms</span>
                    </div>
                </div>
            `;

            container.insertBefore(resultCard, container.firstChild);

            // Reinitialize Lucide icons for new content
            lucide.createIcons();

            // Keep only last 10 results
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }

        // Initialize
        initSocket();

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (visionSession) visionSession.stop();
            if (mediaStream) mediaStream.getTracks().forEach(track => track.stop());
        });
    </script>
</body>
</html>
